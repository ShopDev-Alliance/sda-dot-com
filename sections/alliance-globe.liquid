{% liquid
  comment
    Alliance 3D Globe Section
    Displays an anonymous visualization of member locations globally.
    Locations are grouped by city - no individual identification.
  endcomment

  assign members_data = shop.metaobjects.members.values
  assign dot_color = section.settings.dot_color | default: '#00FFCC'
  assign bg_color = section.settings.bg_color | default: '#050505'
  assign show_timezone_bands = section.settings.show_timezone_bands | default: true
%}

<style>
  #alliance-globe-section-{{ section.id }} {
    position: relative;
    width: 100%;
    height: 700px;
    background-color: {{ bg_color }};
    overflow: hidden;
  }

  @media (max-width: 750px) {
    #alliance-globe-section-{{ section.id }} {
      height: 500px;
    }
  }

  #alliance-globe-section-{{ section.id }} .globe-canvas {
    width: 100%;
    height: 100%;
  }

  #alliance-globe-section-{{ section.id }} .globe-ui-layer {
    position: absolute;
    top: 40px;
    left: 5%;
    z-index: 10;
    pointer-events: none;
    color: #ffffff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  #alliance-globe-section-{{ section.id }} .globe-ui-layer h2 {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0 0 10px 0;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
  }

  @media (max-width: 750px) {
    #alliance-globe-section-{{ section.id }} .globe-ui-layer h2 {
      font-size: 1.75rem;
    }
  }

  #alliance-globe-section-{{ section.id }} .globe-ui-layer p {
    font-size: 1.1rem;
    opacity: 0.8;
    max-width: 400px;
    margin: 0;
  }

  #alliance-globe-section-{{ section.id }} .globe-tooltip {
    background: rgba(10, 15, 30, 0.95);
    border: 1px solid rgba(255, 255, 255, 0.15);
    padding: 10px 14px;
    border-radius: 6px;
    backdrop-filter: blur(4px);
    color: #ffffff;
    font-size: 13px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  #alliance-globe-section-{{ section.id }} .globe-fallback {
    display: none;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    color: #ffffff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  }

  #alliance-globe-section-{{ section.id }} .globe-fallback p {
    margin: 0.5rem 0;
    opacity: 0.8;
  }

  #alliance-globe-section-{{ section.id }} .globe-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #ffffff;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    opacity: 0.6;
  }
</style>

<section id="alliance-globe-section-{{ section.id }}" aria-label="Global member distribution visualization">
  <div class="globe-ui-layer">
    {% if section.settings.heading != blank %}
      <h2>{{ section.settings.heading }}</h2>
    {% endif %}
    {% if section.settings.subheading != blank %}
      <p>{{ section.settings.subheading }}</p>
    {% endif %}
  </div>

  <div class="globe-canvas" id="globe-canvas-{{ section.id }}">
    <div class="globe-loading">Loading globe...</div>
  </div>

  <div class="globe-fallback" id="globe-fallback-{{ section.id }}">
    <p>Interactive globe requires WebGL support.</p>
    <p>SDA members span 18 timezones worldwide.</p>
  </div>
</section>

<script src="//unpkg.com/globe.gl@2.27.0"></script>
<script src="//unpkg.com/topojson-client@3.1.0"></script>

<script>
  (function() {
    const SECTION_ID = '{{ section.id }}';
    const CONFIG = {
      bg: '{{ bg_color }}',
      dotColor: '{{ dot_color }}',
      atmosphere: '#7c4dff',
      showTimezoneBands: {{ show_timezone_bands }}
    };

    {% comment %} Build member location data from metaobjects {% endcomment %}
    const rawMembers = [
      {%- for member in members_data -%}
        {%- if member.coordinates != blank -%}
          {%- assign coords = member.coordinates.value | split: ',' -%}
          {%- assign lat = coords[0] | strip | plus: 0 -%}
          {%- assign lng = coords[1] | strip | plus: 0 -%}
          {%- if lat != 0 or lng != 0 -%}
            {
              city: "{{ member.city.value | default: 'Unknown' | escape }}",
              country: "{{ member.country.value | default: '' | escape }}",
              lat: {{ lat }},
              lng: {{ lng }}
            }{%- unless forloop.last -%},{%- endunless -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
    ].filter(m => m.lat !== undefined);

    {% comment %} Group members by city to create deduplicated location data {% endcomment %}
    function groupByCity(members) {
      const cityMap = {};
      members.forEach(function(m) {
        const key = m.city + '-' + m.country;
        if (!cityMap[key]) {
          cityMap[key] = {
            city: m.city,
            country: m.country,
            lat: m.lat,
            lng: m.lng,
            count: 0
          };
        }
        cityMap[key].count++;
      });
      return Object.values(cityMap);
    }

    const locations = groupByCity(rawMembers);

    {% comment %} Generate timezone bands from unique longitudes {% endcomment %}
    function generateTimezoneBands(locations) {
      const timezones = new Set();
      locations.forEach(function(loc) {
        const tz = Math.round(loc.lng / 15);
        timezones.add(tz);
      });

      return Array.from(timezones).map(function(tz) {
        return {
          lat: 0,
          lng: tz * 15,
          maxR: 90,
          propagationSpeed: 0,
          repeatPeriod: 0
        };
      });
    }

    {% comment %} Check WebGL support {% endcomment %}
    function hasWebGL() {
      try {
        const canvas = document.createElement('canvas');
        return !!(window.WebGLRenderingContext &&
          (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
      } catch (e) {
        return false;
      }
    }

    {% comment %} Initialize the globe {% endcomment %}
    function initGlobe() {
      const container = document.getElementById('globe-canvas-' + SECTION_ID);
      const fallback = document.getElementById('globe-fallback-' + SECTION_ID);
      const loading = container.querySelector('.globe-loading');

      if (!hasWebGL()) {
        if (loading) loading.style.display = 'none';
        fallback.style.display = 'block';
        return;
      }

      if (loading) loading.style.display = 'none';

      const Globe = window.Globe;
      if (!Globe) {
        console.error('Globe.gl library not loaded');
        return;
      }

      {% comment %} Determine globe texture based on style setting {% endcomment %}
      let globeImageUrl = '//unpkg.com/three-globe/example/img/earth-dark.jpg';
      let showPolygons = false;
      {% case section.settings.globe_style %}
        {% when 'light' %}
          globeImageUrl = '//unpkg.com/three-globe/example/img/earth-blue-marble.jpg';
        {% when 'hologram' %}
          globeImageUrl = null;
          showPolygons = true;
      {% endcase %}

      const world = Globe()
        (container)
        .backgroundColor(CONFIG.bg)
        .showAtmosphere(true)
        .atmosphereColor(CONFIG.atmosphere)
        .atmosphereAltitude(0.15)
        .pointsData(locations)
        .pointAltitude(0.01)
        .pointColor(function() { return CONFIG.dotColor; })
        .pointRadius(0.5)
        .pointResolution(16)
        .pointLabel(function(d) {
          const locationText = d.country ? d.city + ', ' + d.country : d.city;
          return '<div class="globe-tooltip">' + locationText + '</div>';
        })
        .autoRotate(true)
        .autoRotateSpeed(0.6);

      {% comment %} Apply globe texture or hologram style {% endcomment %}
      if (globeImageUrl) {
        world.globeImageUrl(globeImageUrl);
        world.bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png');
      }

      {% comment %} Timezone bands {% endcomment %}
      if (CONFIG.showTimezoneBands && locations.length > 0) {
        const timezoneBands = generateTimezoneBands(locations);
        world
          .ringsData(timezoneBands)
          .ringColor(function() { return 'rgba(124, 77, 255, 0.15)'; })
          .ringMaxRadius(90)
          .ringPropagationSpeed(0)
          .ringRepeatPeriod(0);
      }

      {% comment %} Hologram style - vector borders {% endcomment %}
      if (showPolygons) {
        fetch('//unpkg.com/world-atlas/countries-110m.json')
          .then(function(res) { return res.json(); })
          .then(function(countries) {
            world
              .polygonsData(topojson.feature(countries, countries.objects.countries).features)
              .polygonCapColor(function() { return 'rgba(0,0,0,0)'; })
              .polygonSideColor(function() { return 'rgba(0,0,0,0)'; })
              .polygonStrokeColor(function() { return '#2a2a4e'; });
          });
      }

      {% comment %} Responsive resizing {% endcomment %}
      const resizeObserver = new ResizeObserver(function(entries) {
        for (let entry of entries) {
          world.width(entry.contentRect.width);
          world.height(entry.contentRect.height);
        }
      });
      resizeObserver.observe(container.parentElement);
    }

    {% comment %} Lazy load with IntersectionObserver {% endcomment %}
    const section = document.getElementById('alliance-globe-section-' + SECTION_ID);
    const observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          initGlobe();
          observer.disconnect();
        }
      });
    }, { rootMargin: '200px' });

    observer.observe(section);
  })();
</script>

{% schema %}
{
  "name": "Alliance 3D Globe",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Global Alliance"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Connecting developers across 18 timezones"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background Color",
      "default": "#050505"
    },
    {
      "type": "color",
      "id": "dot_color",
      "label": "Dot Color",
      "default": "#00FFCC"
    },
    {
      "type": "select",
      "id": "globe_style",
      "label": "Globe Style",
      "options": [
        {
          "value": "dark",
          "label": "Dark Earth"
        },
        {
          "value": "light",
          "label": "Blue Marble"
        },
        {
          "value": "hologram",
          "label": "Hologram (Wireframe)"
        }
      ],
      "default": "dark"
    },
    {
      "type": "checkbox",
      "id": "show_timezone_bands",
      "label": "Show Timezone Bands",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Alliance 3D Globe"
    }
  ]
}
{% endschema %}
